<!--
  Created by: Mai Van Manh
  Date: 11/02/2020
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Danh sách người dùng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css    ">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    .user {
      display: flex;
      align-items: center;
      padding: 12px 24px;
      cursor: pointer;
    }

    .user:nth-child(odd) {
      background-color: #F4F5F7;
    }

    .user:hover {
      background-color: #E6EFFF;
      transition: 0.3s;
    }

    .avatar {
      font-weight: bold;
      font-size: 1.5rem;
      background-color: deepskyblue;
      width: 50px;
      height: 50px;
      margin-right: 16px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white
    }

    .user-info {
      height: 50px;
      flex-grow: 1;
    }

    .user-name {
      font-size: 1.1rem;
    }

    .user-info .online {
      font-size: 0.9rem;
      color: rgb(99, 99, 99)
    }

    .user .status {
      width: 90px;
      text-align: center;
    }

    .user:hover {
      background-color: #E6EFFF;
    }

    .user:hover .avatar {
      background-color: rgb(7, 142, 204);
      transition: 0.3s;
    }

    .user:hover .user-name {
      font-weight: 450;
      transition: 0.3s;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-7">
        <div class="rounded border mt-5 mb-3">
          <h4 class="text-primary text-center my-5">Danh sách người dùng trực tuyến</h4>
          <div style="padding: 0 24px; display: flex; justify-content: space-between; align-items: center;">
            <p>Số người online: <strong class="badge badge-danger badge-pill">5</strong></p>
            <a href="/logout" class="btn btn-danger btn-sm">Đăng xuất</a>
          </div>
          <div class="people">
          </div>
        </div>
        <p class="small">Danh sách này cần được cập nhật tự động mỗi khi có người dùng đăng nhập hoặc đăng xuất/thoát.
          Ngoài ra trạng thái của mỗi người dùng cũng cần được cập nhật mỗi khi họ tham gia hoặc rời một cuộc trò
          chuyện.</p>
        <p class="small">Để cho đơn giản, trang web chỉ cần hỗ trợ với mỗi người vào một thời điểm, không thể chat với người có trạng thái là <strong>đang bận</strong>.</p>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
      const socket = io();
      // Dữ liệu lấy từ Passport truyền qua EJS
      const currentUser = {
          email: "<%= user.emails[0].value %>",
          name: "<%= user.displayName %>",
          photo: "<%= user.photos[0].value %>"
      };

      // 1. Thông báo mình đã online
      socket.emit('user_connected', currentUser);

      // 2. Lắng nghe cập nhật danh sách người dùng
      socket.on('update_user_list', (usersArray) => {
          const listContainer = document.querySelector('.people');
          const countElement = document.querySelector('.badge-danger');
          
          // Sắp xếp để người đang nhắn cho mình lên đầu (UX tốt hơn)
          usersArray.sort((a, b) => {
              if (a.chattingWith === currentUser.email) return -1;
              if (b.chattingWith === currentUser.email) return 1;
              return 0;
          });

          countElement.innerText = usersArray.length; 
          listContainer.innerHTML = ''; 

          usersArray.forEach(u => {
              // Logic xử lý trạng thái
              let isMyPartner = (u.chattingWith === currentUser.email); // Họ đang chat với mình?
              let isBusy = (u.status === 'Busy');

              let statusBadge = '';
              let clickAction = '';
              let itemStyle = '';

              if (u.email === currentUser.email) {
                  // Là bản thân mình
                  statusBadge = '<div class="badge badge-secondary badge-pill">Bạn</div>';
                  clickAction = 'style="cursor: default;"';
              } 
              else if (isMyPartner) {
                  // TRƯỜNG HỢP QUAN TRỌNG: Họ đang Busy nhưng là chat với mình
                  // -> Cho phép bấm vào để trả lời
                  statusBadge = '<div class="badge badge-primary badge-pill">Đang nhắn cho bạn</div>';
                  clickAction = `onclick="window.location.href='/chat?partner=${u.email}'"`;
                  itemStyle = 'background-color: #e3f2fd;'; // Highlight màu xanh nhạt
              } 
              else if (isBusy) {
                  // Họ đang Busy với người khác -> Chặn
                  statusBadge = '<div class="badge badge-warning badge-pill">Đang bận</div>';
                  clickAction = 'style="cursor: not-allowed; opacity: 0.6;"';
              } 
              else {
                  // Họ đang Rảnh -> Cho phép bấm
                  statusBadge = '<div class="badge badge-success badge-pill">Đang rảnh</div>';
                  clickAction = `onclick="window.location.href='/chat?partner=${u.email}'"`;
              }

              let html = `
              <div class="user" ${clickAction} style="${itemStyle}">
                  <div class="avatar"><img src="${u.avatar}" style="width:100%; border-radius:50%"></div>
                  <div class="user-info">
                  <div class="user-name">${u.name}</div>
                  <div class="online">${u.email}</div>
                  </div>
                  <div class="status">
                  ${statusBadge}
                  </div>
              </div>`;
              listContainer.innerHTML += html;
          });
      });

      // THÊM: Hiển thị thông báo góc màn hình khi có người nhắn tới
      socket.on('incoming_chat', (data) => {
          // Tạo thông báo Toast (Góc dưới trái)
          const toast = document.createElement('div');
          toast.className = 'alert alert-info position-fixed small';
          toast.style.bottom = '80px'; // Cao hơn thông báo online một chút
          toast.style.left = '20px';
          toast.style.zIndex = '1000';
          toast.style.cursor = 'pointer';
          toast.innerHTML = `<strong>${data.senderName}</strong> đang nhắn tin cho bạn. <br><u>Bấm để trả lời ngay</u>`;
          
          // Bấm vào thông báo thì chuyển trang luôn
          toast.onclick = function() {
              window.location.href = `/chat?partner=${data.senderEmail}`;
          };

          document.body.appendChild(toast);

          // Tự tắt sau 5 giây
          setTimeout(() => { toast.remove(); }, 5000);
      });

      // Lắng nghe sự kiện người dùng online
      socket.on('user_online_notification', (userData) => {
        // Chỉ hiển thị thông báo nếu không phải là chính mình
        if (userData.email !== currentUser.email) {
          // Tạo và hiển thị thông báo online
          const onlineNotification = document.createElement('div');
          onlineNotification.id = 'online-notification';
          onlineNotification.className = 'alert alert-success d-inline position-fixed small';
          onlineNotification.style.bottom = '20px';
          onlineNotification.style.left = '20px';
          onlineNotification.innerHTML = `<strong>${userData.name}</strong> vừa mới online`;
          document.body.appendChild(onlineNotification);
          
          // Ẩn thông báo sau 3 giây
          setTimeout(() => {
            if (document.getElementById('online-notification')) {
              document.getElementById('online-notification').remove();
            }
          }, 3000);
        }
      });

      // Lắng nghe sự kiện người dùng offline
      socket.on('user_offline_notification', (userData) => {
        // Tạo và hiển thị thông báo offline
        const offlineNotification = document.createElement('div');
        offlineNotification.id = 'offline-notification';
        offlineNotification.className = 'alert alert-danger d-inline position-fixed small';
        offlineNotification.style.bottom = '20px';
        offlineNotification.style.right = '20px';
        offlineNotification.innerHTML = `<strong>${userData.name}</strong> đã thoát khỏi ứng dụng`;
        document.body.appendChild(offlineNotification);
        
        // Ẩn thông báo sau 3 giây
        setTimeout(() => {
          if (document.getElementById('offline-notification')) {
            document.getElementById('offline-notification').remove();
          }
        }, 3000);
      });
    </script>
</body>

</html>